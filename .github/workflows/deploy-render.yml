name: Deploy to Render

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting
      run: npm run lint:check
      
    - name: Build application
      run: npm run build
      
    - name: Test build output
      run: |
        # V√©rifier que le build a cr√©√© les fichiers n√©cessaires
        if [ ! -d "dist" ]; then
          echo "‚ùå Build failed: dist directory not found"
          exit 1
        fi
        
        # V√©rifier la taille du bundle (optimisation √©co-conception)
        BUNDLE_SIZE=$(du -sh dist | cut -f1)
        echo "üì¶ Bundle size: $BUNDLE_SIZE"
        
        # V√©rifier que les assets sont pr√©sents
        if [ ! -f "dist/index.html" ]; then
          echo "‚ùå Build failed: index.html not found"
          exit 1
        fi
        
        echo "‚úÖ Build successful"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: |
          dist/
          backend/
          package.json
          package-lock.json
        retention-days: 7

  deploy-to-render:
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: ./
        
    - name: Deploy to Render
      run: |
        echo "üöÄ Deploying to Render..."
        
        # D√©clencher un nouveau d√©ploiement via l'API Render
        if [ -n "${{ secrets.RENDER_SERVICE_ID }}" ] && [ -n "${{ secrets.RENDER_API_KEY }}" ]; then
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            -d '{"clearCache": "do_not_clear"}' || echo "‚ö†Ô∏è Deploy trigger failed, but continuing..."
        else
          echo "‚ÑπÔ∏è Render secrets not configured, skipping deployment"
        fi
        
    - name: Verify deployment
      run: |
        # Attendre que le d√©ploiement soit termin√©
        sleep 30
        
        # V√©rifier que l'application r√©pond
        if [ -n "${{ secrets.RENDER_URL }}" ]; then
          echo "üîç Checking deployment at ${{ secrets.RENDER_URL }}"
          
          # Test de connectivit√©
          if curl -f -s "${{ secrets.RENDER_URL }}/api/server" > /dev/null; then
            echo "‚úÖ API endpoint responding"
          else
            echo "‚ö†Ô∏è API endpoint not responding"
          fi
          
          # Test de la page principale
          if curl -f -s "${{ secrets.RENDER_URL }}" > /dev/null; then
            echo "‚úÖ Main page responding"
          else
            echo "‚ö†Ô∏è Main page not responding"
          fi
        else
          echo "‚ÑπÔ∏è RENDER_URL not configured, skipping verification"
        fi

  

  notify-deployment:
    needs: [deploy-to-render]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "üöÄ Deployment Summary"
        echo "===================="
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "Deployment URL: ${{ secrets.RENDER_URL }}"
        
        if [ "${{ needs.deploy-to-render.result }}" == "success" ]; then
          echo "‚úÖ Deploy: SUCCESS"
        else
          echo "‚ùå Deploy: FAILED"
        fi
        
 